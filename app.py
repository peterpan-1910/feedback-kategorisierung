import streamlit as st
import pandas as pd
import hashlib
import openai
import streamlit.components.v1 as components

# ------------- Benutzerverwaltung (Login) ----------------
USER_CREDENTIALS = {
    "admin2025": hashlib.sha256("admin2025".encode()).hexdigest()
}

def check_login(username, password):
    hashed = hashlib.sha256(password.encode()).hexdigest()
    return USER_CREDENTIALS.get(username) == hashed

# ------------- Regelbasierte Kategorisierung (erweitert) --------------
def kategorisieren_feedback(feedback, kategorien):
    feedback = feedback.lower()

    if any(word in feedback for word in ["funktion fehlt", "es fehlt", "w√§re gut", "sollte m√∂glich sein", "keine sofort√ºberweisung"]):
        return "Feature-W√ºnsche / Kritik"
    if any(word in feedback for word in ["funktioniert nicht", "geht nicht", "abbruch", "bug", "fehler"]):
        return "Fehler / Bugs"
    if any(word in feedback for word in ["√ºbersicht", "un√ºbersichtlich", "struktur verwirrend"]):
        return "un√ºbersichtlich"
    if any(word in feedback for word in ["langsam", "l√§dt", "ewig", "dauert lange"]):
        return "langsam"
    if any(word in feedback for word in ["kontakt", "hotline", "anruf", "nicht erreichbar", "niemand erreichbar", "support"]):
        return "Kundenservice"
    if any(word in feedback for word in ["ratenkauf", "r√ºckzahlung", "rate", "zur√ºckzahlen"]):
        return "R√ºckzahlungsoptionen"
    if any(word in feedback for word in ["login", "einloggen", "anmeldung", "logout"]):
        return "Login"
    if any(word in feedback for word in ["absturz", "app h√§ngt", "st√ºrzt ab"]):
        return "App abst√ºrze"
    if any(word in feedback for word in ["tan", "sms tan", "best√§tigungscode"]):
        return "TAN Probleme"
    if any(word in feedback for word in ["kosten", "geb√ºhr", "zinsen"]):
        return "Geb√ºhren"
    if any(word in feedback for word in ["veraltet", "nicht modern", "altmodisch"]):
        return "UI/UX"
    if any(word in feedback for word in ["kompliziert", "nicht intuitiv", "nicht verst√§ndlich", "nicht selbsterkl√§rend"]):
        return "Kompliziert / Unklar"
    if any(word in feedback for word in ["vertrauen", "abzocke", "dubios", "nicht vertrauensw√ºrdig"]):
        return "Vertrauensw√ºrdigkeit"
    if any(word in feedback for word in ["english", "englisch", "not in german"]):
        return "Sprachprobleme"
    if any(word in feedback for word in ["werbung", "angebot", "promo"]):
        return "Werbung"
    if any(word in feedback for word in ["sicherheit", "sicherheitsbedenken", "schutz"]):
        return "Sicherheit"
    if any(word in feedback for word in ["tagesgeld", "zins", "geldanlage"]):
        return "Tagesgeld"
    if any(word in feedback for word in ["zahlung", "√ºberweisung", "geld senden"]):
        return "Zahlungsprobleme"
    if any(word in feedback for word in ["ansprechpartner", "kontaktm√∂glichkeit", "r√ºckruf"]):
        return "Kontaktm√∂glichkeiten"
    return "Sonstiges"

# ------------- GPT-Kategorisierung (optional bei API-Key) --------------
def kategorisieren_mit_gpt(feedback, kategorien, api_key):
    openai.api_key = api_key
    try:
        client = openai.OpenAI(api_key=api_key)
        prompt = f"""
        Du bist ein System zur Textklassifikation. Ordne das folgende deutsche Kundenfeedback genau einer dieser Kategorien zu:
        {', '.join(kategorien)}.
        Feedback: \"{feedback}\"
        Antworte nur mit der Kategorie (ohne weitere Erkl√§rungen).
        """
        response = client.chat.completions.create(
            model="gpt-3.5-turbo",
            messages=[{"role": "user", "content": prompt}],
            max_tokens=20
        )
        return response.choices[0].message.content.strip()
    except Exception as e:
        return f"Fehler: {str(e)}"

# ----------------- Streamlit App -------------------
def main():
    st.set_page_config(page_title="Feedback Analyse", layout="wide")

    if "logged_in" not in st.session_state:
        st.session_state.logged_in = False

    if not st.session_state.logged_in:
        st.markdown("""
            <style>
                .main {background-color: #0f1117; color: #ffffff;}
                .stTextInput > div > div > input {
                    background-color: #1e1e2f;
                    color: white;
                }
                .stTextInput > label, .stPassword > label {
                    color: #ffffff;
                }
            </style>
        """, unsafe_allow_html=True)

        st.markdown("# ‚ú® Willkommen zur KI-gest√ºtzten Feedbackanalyse")
        st.markdown("Bitte logge dich ein, um loszulegen.")

        username = st.text_input("üë§ Benutzername")
        password = st.text_input("üîê Passwort", type="password")
        login_button = st.button("üö™ Login")

        if login_button:
            if check_login(username, password):
                st.session_state.logged_in = True
            else:
                st.error("Falscher Benutzername oder Passwort")
        return

    # Nach Login
    st.markdown("## üìä Feedback Kategorisierung auf Basis von GPT oder Regeln")

    st.sidebar.header("‚öôÔ∏è Kategorien verwalten")
    default_kategorien = [
        "Login", "TAN Probleme", "App abst√ºrze", "Fehler / Bugs",
        "R√ºckzahlungsoptionen", "Zahlungsprobleme", "Kompliziert / Unklar",
        "Feature-W√ºnsche / Kritik", "Sprachprobleme", "Sicherheit", "Tagesgeld",
        "Werbung", "UI/UX", "un√ºbersichtlich", "langsam", "Kundenservice",
        "Kontaktm√∂glichkeiten", "Vertrauensw√ºrdigkeit", "Geb√ºhren", "Sonstiges"
    ]

    kategorien = st.sidebar.text_area("Kategorien (eine pro Zeile)", "\n".join(default_kategorien)).splitlines()

    st.sidebar.markdown("---")
    method = st.sidebar.selectbox("Kategorisierungsmethode", ["GPT", "Regelbasiert"])
    api_key = None
    if method == "GPT":
        api_key = st.sidebar.text_input("üîë OpenAI API-Key", type="password", key="api", help="Dein OpenAI-Schl√ºssel wird nicht gespeichert")

    uploaded_file = st.file_uploader("üì§ Excel-Datei mit Feedback hochladen", type=["xlsx"])
    if uploaded_file:
        df = pd.read_excel(uploaded_file)
        if 'Feedback' not in df.columns:
            st.error("Die Excel-Datei muss eine Spalte 'Feedback' enthalten.")
            return

        kategorien_clean = [k.strip() for k in kategorien if k.strip() != ""]

        if method == "GPT" and api_key:
            st.info("Kategorisierung l√§uft. Bitte etwas Geduld...")
            progress_bar = st.progress(0)
            kategorien_list = []
            for i, feedback in enumerate(df['Feedback']):
                kategorie = kategorisieren_mit_gpt(str(feedback), kategorien_clean, api_key)
                kategorien_list.append(kategorie)
                progress_bar.progress((i + 1) / len(df))
            df['Kategorie'] = kategorien_list
        else:
            df['Kategorie'] = df['Feedback'].apply(lambda x: kategorisieren_feedback(str(x), kategorien_clean))

        st.success("Kategorisierung abgeschlossen!")
        st.dataframe(df[['Feedback', 'Kategorie']])

        csv = df.to_csv(index=False).encode('utf-8')
        st.download_button("üì• Ergebnisse als CSV herunterladen", csv, "kategorisiertes_feedback.csv", "text/csv")

if __name__ == '__main__':
    main()
